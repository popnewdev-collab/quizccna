<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CCNA PREP QUIZ</title>
  <meta name="description" content="CCNA PREP QUIZ - teste seus conhecimentos para a certificação CCNA" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap">
  <style>
    :root {
      --bg: #0f172a;
      --card: #0b1220;
      --accent: #0ea5a4;
      --muted: #94a3b8;
      --success: #16a34a;
      --danger: #ef4444;
      --focus: #fbbf24;
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, sans-serif;
      color: #e6eef6;
      background: linear-gradient(180deg,#071028 0%, #08122a 100%);
      padding: 16px;
      min-height: 100vh;
    }
    .app { max-width: 980px; margin: 0 auto; }
    header { margin-bottom: 12px }
    .controls { 
      display: flex; 
      gap: 8px; 
      flex-wrap: wrap; 
      align-items: center;
      justify-content: flex-end;
    }
    .actions-inline {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 24px;
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      padding: 10px 18px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .timer-box {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      padding: 6px 18px;
      min-width: 130px;
      justify-content: center;
    }
    .quiz-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    h1 { font-size: 1.2rem; margin: 0 }
    .sub { color: var(--muted); font-size: .9rem }
    button, select {
      background: linear-gradient(180deg,#0b1b2a,#06101a);
      border: 1px solid rgba(255,255,255,.08);
      color: #e6eef6;
      padding: 10px 12px;
      border-radius: 10px;
      font-weight: 600;
      font-family: inherit;
      transition: border-color .18s, box-shadow .18s;
      outline: none;
      cursor: pointer;
    }
    button:focus, .opt:focus, select:focus { border-color: var(--focus); box-shadow: 0 0 0 2px var(--focus); }
    .btn-primary {
      background: linear-gradient(180deg,var(--accent),#0ca89f);
      color: #042022;
      border: none;
    }
    .btn-ghost { background: transparent; border: 1px solid rgba(255,255,255,.10);}
    .stats-inline {
      display: flex;
      gap: 24px;
      justify-content: center;
      align-items: center;
      margin: 10px 0 20px 0;
      font-size: 1rem;
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      padding: 10px 18px;
    }
    .stats-inline span {
      color: var(--muted);
    }
    .stats-inline strong {
      color: #e6eef6;
      font-weight: 600;
      margin-right: 2px;
    }
    @media (max-width: 700px) {
      .stats-inline, .actions-inline { font-size: .98rem; gap: 10px; padding: 8px 4px; flex-wrap: wrap;}
      .controls { flex-wrap: wrap; gap: 6px; }
      #categorySelect { width: 100%; min-width: 140px; }
    }
    main { display: grid; grid-template-columns: 1fr; gap: 14px }
    .card {
      background: rgba(255,255,255,0.04);
      padding: 16px;
      border-radius: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,.4);
    }
    .question-num { font-size: .9rem; color: var(--muted) }
    .question-text { font-size: 1.08rem; margin: 8px 0 8px }
    .question-image { max-width:100%;border-radius:8px;margin-top:8px }
    .options { display: grid; gap: 10px; margin-top: 8px }
    .opt {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 13px 10px;
      border-radius: 10px;
      border: 2px solid rgba(255,255,255,.04);
      background: none;
      cursor: pointer;
      transition: background 0.16s, border-color 0.16s;
      font-size: 1rem;
      font-family: inherit;
      outline: none;
      user-select: none;
      text-align: left;
    }
    .opt[aria-pressed="true"] { outline: 2px solid var(--focus); }
    .opt.opt-disabled { opacity: .65; cursor: not-allowed; }
    .opt .letter {
      min-width: 34px; height: 34px;
      border-radius: 8px;
      display: grid; place-items: center;
      background: rgba(255,255,255,0.04);
      font-weight: 700;
      font-size: 1.1em;
    }
    .opt.correct {
      border-color: rgba(22,163,74,.7);
      background: linear-gradient(90deg, rgba(16,185,129,0.09), rgba(16,185,129,0.05));
    }
    .opt.wrong {
      border-color: rgba(239,68,68,.35);
      background: linear-gradient(90deg, rgba(239,68,68,0.07), rgba(239,68,68,0.01));
    }
    .opt img { max-height: 80px; border-radius: 6px }
    .explanation {
      margin-top: 12px;
      padding: 12px;
      border-radius: 8px;
      background: rgba(255,255,255,0.06);
      color: var(--muted);
      font-size: .99rem;
      animation: fadeIn .3s;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to   { opacity: 1; }
    }
    .small { font-size: .89rem; color: var(--muted) }
    .mode-indicator {
      padding: 6px 10px; border-radius: 8px;
      background: rgba(255,255,255,0.03); font-weight: 700;
    }
    footer { margin-top: 16px; color: var(--muted); font-size: .9rem }
    .hint { font-size: .85rem; color: var(--muted) }
    .visually-hidden { position: absolute !important; width: 1px; height: 1px; padding: 0; overflow: hidden; border: 0; clip: rect(0,0,0,0); white-space: nowrap }
    .timer { font-size: 1.09rem; font-weight: 800; color: var(--accent) }
  </style>
</head>
<body>
  <div class="app" role="main">
    <header>
      <div class="controls" role="group" aria-label="Modos">
        <span class="mode-indicator" id="modeIndicator">Modo: <strong>Quiz</strong></span>
        <button id="btnQuiz" class="btn-primary" aria-pressed="true" tabindex="0">Quiz</button>
        <button id="btnSimulado" class="btn-ghost" aria-pressed="false" tabindex="0">Simulado</button>
        <label class="small" for="categorySelect" style="margin-left:10px;">Filtrar categoria</label>
        <select id="categorySelect" style="width:160px;">
          <option value="all">Todas as categorias</option>
        </select>
      </div>
    </header>

    <!-- LINHA CENTRALIZADA DE AÇÕES -->
    <div class="actions-inline">
      <button id="restartBtn" aria-label="Reiniciar quiz">Reiniciar</button>
      <button id="shuffleBtn" class="btn-ghost" aria-label="Embaralhar perguntas">Embaralhar</button>
      <div class="timer-box">
        <span class="small">Tempo simulado</span>
        <span class="timer" id="timerDisplay" aria-live="polite">--:--:--</span>
      </div>
    </div>

    <!-- LINHA DE CONTADORES INLINE -->
    <div class="stats-inline" id="statsInline" role="region" aria-label="Estatísticas do quiz">
      <span><strong>Perguntas:</strong> <span id="totalAsked">0</span></span>
      <span><strong>Acertos:</strong> <span id="totalCorrect">0</span></span>
      <span><strong>Erros:</strong> <span id="totalWrong">0</span></span>
      <span><strong>Progresso:</strong> <span id="progress">0%</span></span>
    </div>

    <main>
      <section>
        <div class="card" id="questionCard">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="question-num" id="qMeta" aria-live="polite">Carregando perguntas...</div>
              <div class="question-text" id="questionText">—</div>
              <img id="questionImage" class="question-image" src="" alt="" style="display:none">
            </div>
          </div>
          <div class="options" id="options" role="group" aria-label="Alternativas"></div>
          <div id="explanation" class="explanation" style="display:none"></div>
          <div style="display:flex;justify-content:space-between;margin-top:14px;gap:8px">
            <div class="hint">Selecione as alternativas corretas. A validação é automática.</div>
            <div>
              <button id="nextBtn" aria-label="Próxima pergunta" tabindex="0">Próxima</button>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <div>
        Observação: para carregar perguntas, configure as variáveis <code>SHEET_API_URL</code> (Apps Script) ou <code>SHEET_CSV_URL</code> (CSV) no topo do arquivo.<br>
        <span class="visually-hidden" id="accessibilityStatus"></span>
      </div>
    </footer>
  </div>
  <script>
    // ====== CONFIGURAÇÕES ======
    const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbwVSF5dSd3VFV6jAQBTuhiM9WD8SOqYWttUVzSbNAbcCKqP_6XD00EspkTXHtBb1CnqAQ/exec";
    const SHEET_CSV_URL = ""; // Ex: https://docs.google.com/spreadsheets/d/ID/export?format=csv
    const CATEGORIES = [
      "Network Fundamentals",
      "Network Access",
      "IP connectivity",
      "IP services",
      "Security Fundamentals",
      "Programmability"
    ];
    // ====== VARIÁVEIS DE ESTADO ======
    let allQuestions = [];
    let current = null;
    let answeredQuestions = new Set();
    let asked = 0, correctCount = 0, wrongCount = 0;
    let mode = 'quiz';
    let simQuestions = [];
    let simIndex = 0;
    let timer = null;
    let timeLeft = 0;

    // ====== HELPERS ======
    function escapeHTML(str = '') {
      return str.replace(/[&<>"']/g, m =>
        ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
      );
    }
    function shuffleArray(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }
    function formatTime(s) {
      if (s < 0) s = 0;
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const sec = s % 60;
      return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
    }
    function arraysEqual(a, b) {
      if (a.length !== b.length) return false;
      for (let i = 0; i < a.length; i++) if (a[i] !== b[i]) return false;
      return true;
    }
    function focusFirstOption() {
      const first = document.querySelector('.opt:not(.opt-disabled)');
      if (first) first.focus();
    }
    // Parse CSV simples
    function parseCSV(csv) {
      const lines = csv.split(/\r?\n/).filter(l => l.trim() !== "");
      const headers = lines.shift().split(/,|;|\t/).map(h => h.trim());
      return lines.map(line => {
        const values = [];
        let cur = '', inQ = false;
        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          if (ch === '"') inQ = !inQ;
          else if (ch === ',' && !inQ) { values.push(cur); cur = ''; }
          else cur += ch;
        }
        values.push(cur);
        const obj = {};
        for (let i = 0; i < headers.length; i++)
          obj[headers[i]] = (values[i] || '').trim().replace(/^"|"$/g, '');
        return obj;
      });
    }

    // ====== LOADING E PREPARAÇÃO ======
    async function loadSheet() {
      try {
        let data = null;
        if (SHEET_API_URL) {
          const res = await fetch(SHEET_API_URL);
          if (!res.ok) throw new Error('Falha na API: ' + res.status);
          data = await res.json();
        } else if (SHEET_CSV_URL && !SHEET_CSV_URL.includes('PASTE_YOUR') && SHEET_CSV_URL.length > 10) {
          const res = await fetch(SHEET_CSV_URL);
          if (!res.ok) throw new Error('Falha ao buscar CSV: ' + res.status);
          const txt = await res.text();
          data = parseCSV(txt);
        } else {
          document.getElementById('qMeta').innerText = 'Configure SHEET_API_URL ou SHEET_CSV_URL nas configs.';
          return;
        }
        allQuestions = (data || []).map((r, idx) => ({
          id: r.id || idx + 1,
          question: (r.question || r.pergunta || '').toString(),
          questionImage: (r.questionImage || r.questionimage || r.image || '').toString(),
          options: {
            A: (r.optionA || r.A || '').toString(),
            B: (r.optionB || r.B || '').toString(),
            C: (r.optionC || r.C || '').toString(),
            D: (r.optionD || r.D || '').toString()
          },
          optionImages: {
            A: (r.optionAImage||r.optionaimage||'').toString(),
            B: (r.optionBImage||r.optionbimage||'').toString(),
            C: (r.optionCImage||r.optioncimage||'').toString(),
            D: (r.optionDImage||r.optiondimage||'').toString()
          },
          correct: (r.correct||r.answer||'').toString().replace(/\s+/g,'').replace(/,/g,';').split(';').filter(Boolean).map(s=>s.toUpperCase()),
          category: (r.category||'').toString().trim(),
          explanation: (r.explanation || '').toString()
        })).filter(q => q.question && (q.options.A || q.options.B || q.options.C || q.options.D));
        // Popular categorias
        const sel = document.getElementById('categorySelect');
        Array.from(sel.querySelectorAll('option:not([value="all"])')).forEach(o => o.remove());
        const present = new Set(allQuestions.map(q => q.category));
        const catsToShow = CATEGORIES.filter(c => present.has(c));
        for (const cat of catsToShow) {
          const opt = document.createElement('option');
          opt.value = cat; opt.innerText = cat; sel.appendChild(opt);
        }
        if (allQuestions.length === 0) {
          document.getElementById('qMeta').innerText = 'Planilha carregada mas sem perguntas válidas.';
          return;
        }
        updateStats();
        nextQuestion();
      } catch (err) {
        console.error(err);
        document.getElementById('qMeta').innerText = 'Erro ao carregar planilha: ' + err.message;
      }
    }

    // ====== RENDERIZAÇÃO ======
    function renderQuestion(q) {
      const qMeta = document.getElementById('qMeta');
      const qText = document.getElementById('questionText');
      const qImg = document.getElementById('questionImage');
      const opts = document.getElementById('options');
      const expl = document.getElementById('explanation');
      if (!q) {
        qMeta.innerText = 'Nenhuma pergunta disponível';
        qText.innerText = '—';
        opts.innerHTML = '';
        expl.style.display = 'none';
        qImg.style.display = 'none';
        return;
      }
      current = q;
      qMeta.innerText = `ID ${escapeHTML(q.id.toString())} — Categoria: ${escapeHTML(q.category||'—')}`;
      qText.innerText = q.question;
      if (q.questionImage) {
        qImg.src = q.questionImage;
        qImg.style.display = 'block';
        qImg.alt = "Imagem da pergunta";
      } else {
        qImg.style.display = 'none';
        qImg.src = '';
      }
      opts.innerHTML = '';
      expl.style.display = 'none';
      expl.innerHTML = '';
      ['A','B','C','D'].forEach(letter => {
        const txt = q.options[letter];
        if (!txt) return;
        const btn = document.createElement('button');
        btn.type = "button";
        btn.className = 'opt';
        btn.dataset.letter = letter;
        btn.setAttribute('aria-label', `Alternativa ${letter}: ${txt}`);
        btn.tabIndex = 0;
        let imgHtml = '';
        if (q.optionImages && q.optionImages[letter]) {
          imgHtml = `<img src="${escapeHTML(q.optionImages[letter])}" alt="Imagem alternativa ${letter}">`;
        }
        btn.innerHTML = `<span class="letter">${letter}</span><span class="text">${escapeHTML(txt)}</span>${imgHtml}`;
        btn.addEventListener('click', onSelectOption);
        btn.addEventListener('keydown', e => {
          if (e.key === "Enter" || e.key === " ") { e.preventDefault(); btn.click(); }
        });
        opts.appendChild(btn);
      });
      setTimeout(focusFirstOption, 120);
    }

    function showExplanation(isCorrect) {
      const expl = document.getElementById('explanation');
      expl.style.display = 'block';
      expl.innerHTML = `<strong>${isCorrect ? 'Acertou ✔' : 'Errou ✖'}</strong><div style="margin-top:8px">${escapeHTML(current.explanation || 'Sem explicação.')}</div>`;
      // Feedback visual (e.g. shake)
      if (!isCorrect) {
        document.getElementById('questionCard').animate([{transform:'translateX(0)'},{transform:'translateX(-6px)'},{transform:'translateX(6px)'},{transform:'translateX(0)'}],{duration:360});
      }
      // Feedback acessibilidade
      const acc = document.getElementById('accessibilityStatus');
      acc.innerText = isCorrect ? "Resposta correta" : "Resposta errada";
      acc.setAttribute('aria-live', 'assertive');
    }

    // ====== LÓGICA DE SELEÇÃO E VALIDAÇÃO ======
    function onSelectOption(e) {
      if (!current) return;
      const btn = e.currentTarget;
      if (btn.classList.contains('opt-disabled')) return;
      btn.setAttribute('aria-pressed', btn.getAttribute('aria-pressed') === "true" ? "false" : "true");
      btn.classList.toggle('selected');
      // múltiplas alternativas?
      const selected = Array.from(document.querySelectorAll('.opt.selected')).map(x => x.dataset.letter);
      const needed = current.correct.length || 1;
      if (current.correct.length <= 1 || selected.length >= needed) {
        validateAnswer(selected);
      }
    }

    function validateAnswer(selected) {
      document.querySelectorAll('.opt').forEach(o => {
        o.classList.add('opt-disabled');
        o.removeEventListener('click', onSelectOption);
      });
      const correct = current.correct.slice().sort();
      const selSorted = selected.slice().sort();
      const isCorrect = arraysEqual(correct, selSorted);
      document.querySelectorAll('.opt').forEach(o => {
        const l = o.dataset.letter;
        if (correct.includes(l)) o.classList.add('correct');
        if (selected.includes(l) && !correct.includes(l)) o.classList.add('wrong');
      });
      asked++;
      if (isCorrect) correctCount++; else wrongCount++;
      updateStats();
      showExplanation(isCorrect);
      answeredQuestions.add(current.id);
      if (mode === 'simulado') {
        simIndex++;
        if (simIndex < simQuestions.length) setTimeout(() => loadSimQuestion(simIndex), 900);
      }
    }

    // ====== NAVEGAÇÃO E ESTATÍSTICAS ======
    function updateStats() {
      document.getElementById('totalAsked').innerText = asked;
      document.getElementById('totalCorrect').innerText = correctCount;
      document.getElementById('totalWrong').innerText = wrongCount;
      const pct = Math.round((correctCount / Math.max(1, asked)) * 100);
      document.getElementById('progress').innerText = pct + '%';
    }

    function updateStatsInlineVisibility() {
      const stats = document.getElementById('statsInline');
      if (mode === 'quiz') {
        stats.style.display = '';
      } else {
        stats.style.display = 'none';
      }
    }

    function nextQuestion() {
      const cat = document.getElementById('categorySelect').value;
      let candidates = (cat === 'all') ? allQuestions.slice() : allQuestions.filter(q => q.category === cat);
      if (candidates.length === 0) { renderQuestion(null); return; }
      const notAsked = candidates.filter(q => !answeredQuestions.has(q.id));
      const poolCand = notAsked.length ? notAsked : candidates;
      const q = poolCand[Math.floor(Math.random() * poolCand.length)];
      renderQuestion(q);
    }
    function prepareSimulated() {
      const grouped = {};
      for (const cat of CATEGORIES) grouped[cat] = allQuestions.filter(q => q.category === cat);
      simQuestions = [];
      for (const cat of CATEGORIES) {
        const arr = grouped[cat] || [];
        const shuffled = shuffleArray(arr);
        simQuestions.push(...shuffled.slice(0, 16));
      }
      simQuestions = shuffleArray(simQuestions);
      simIndex = 0;
      answeredQuestions = new Set();
      asked = 0; correctCount = 0; wrongCount = 0;
      updateStats();
    }
    function loadSimQuestion(i) {
      if (!simQuestions[i]) { renderQuestion(null); return; }
      renderQuestion(simQuestions[i]);
    }

    // ====== TIMER SIMULADO ======
    function startTimer(seconds) {
      stopTimer();
      timeLeft = seconds;
      document.getElementById('timerDisplay').innerText = formatTime(timeLeft);
      timer = setInterval(() => {
        timeLeft--;
        document.getElementById('timerDisplay').innerText = formatTime(timeLeft);
        if (timeLeft <= 0) { stopTimer(); onSimTimeUp(); }
      }, 1000);
    }
    function stopTimer() { if (timer) clearInterval(timer); timer = null; }
    function onSimTimeUp() {
      const totalNeeded = simQuestions.length;
      const totalAnswered = asked;
      if (totalAnswered < totalNeeded) {
        alert(`Tempo esgotado! Você respondeu ${totalAnswered} de ${totalNeeded} perguntas. Resultado: REPROVADO.`);
      } else {
        alert(`Tempo esgotado! Você respondeu todas as perguntas. Acertos: ${correctCount} / ${totalNeeded}`);
      }
    }

    // ====== EVENTOS ======
    document.getElementById('btnQuiz').addEventListener('click', () => {
      mode = 'quiz';
      document.getElementById('modeIndicator').innerHTML = 'Modo: <strong>Quiz</strong>';
      stopTimer(); document.getElementById('timerDisplay').innerText = '--:--:--';
      answeredQuestions = new Set(); asked = 0; correctCount = 0; wrongCount = 0; updateStats();
      document.getElementById('btnQuiz').setAttribute('aria-pressed','true');
      document.getElementById('btnSimulado').setAttribute('aria-pressed','false');
      updateStatsInlineVisibility();
      nextQuestion();
    });

    document.getElementById('btnSimulado').addEventListener('click', () => {
      mode = 'simulado';
      document.getElementById('modeIndicator').innerHTML = 'Modo: <strong>Simulado</strong>';
      document.getElementById('btnQuiz').setAttribute('aria-pressed','false');
      document.getElementById('btnSimulado').setAttribute('aria-pressed','true');
      updateStatsInlineVisibility();
      prepareSimulated(); startTimer(120 * 60); loadSimQuestion(0);
    });

    document.getElementById('nextBtn').addEventListener('click', () => {
      if (mode === 'quiz') nextQuestion();
      else { if (simIndex < simQuestions.length - 1) { simIndex++; loadSimQuestion(simIndex); } else alert('Fim do simulado.'); }
    });
    document.getElementById('restartBtn').addEventListener('click', () => {
      answeredQuestions = new Set(); asked = 0; correctCount = 0; wrongCount = 0; updateStats();
      if (mode === 'simulado') { prepareSimulated(); startTimer(120 * 60); loadSimQuestion(0); }
      else nextQuestion();
    });
    document.getElementById('shuffleBtn').addEventListener('click', () => {
      allQuestions = shuffleArray(allQuestions);
      alert('Banco embaralhado.');
      if (mode === 'quiz') nextQuestion();
      else if (mode === 'simulado') { prepareSimulated(); loadSimQuestion(0); }
    });
    document.getElementById('categorySelect').addEventListener('change', () => {
      if (mode === 'quiz') nextQuestion();
    });

    // ====== INICIALIZA ======
    loadSheet();
    updateStatsInlineVisibility();
  </script>
</body>
</html>
