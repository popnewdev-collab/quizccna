<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CCNA Prep Quiz</title>
  <meta name="description" content="Teste seus conhecimentos para a certificação CCNA com este quiz interativo." />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap">
  <style>
    /* === Variáveis Globais === */
    :root {
      --bg: #0f172a;
      --card: #0b1220;
      --accent: #0ea5a4;
      --muted: #94a3b8;
      --success: #16a34a;
      --danger: #ef4444;
      --focus: #fbbf24;
      --text-primary: #e6eef6;
      --border: rgba(255,255,255,.08);
      --shadow: 0 6px 18px rgba(0,0,0,.4);
      --transition: all 0.2s ease-in-out;
    }

    /* === Reset e Base === */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, sans-serif;
      color: var(--text-primary);
      background: linear-gradient(180deg, #071028 0%, #08122a 100%);
    }

    body {
      padding: 1rem;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .app {
      max-width: 980px;
      width: 100%;
      margin: 0 auto;
    }

    /* === Cabeçalho === */
    header {
      margin-bottom: 1rem;
    }

    .mode-header {
      margin-bottom: 0.5rem;
      text-align: left;
    }

    .mode-indicator {
      padding: 0.375rem 0.625rem;
      border-radius: 0.5rem;
      background: rgba(255,255,255,0.03);
      font-weight: 700;
      display: inline-block;
    }

    .controls {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-end;
    }

    /* === Controles e Botões === */
    button, select {
      background: linear-gradient(180deg, #0b1b2a, #06101a);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 0.625rem 0.75rem;
      border-radius: 0.625rem;
      font-weight: 600;
      font-family: inherit;
      transition: var(--transition);
      outline: none;
      cursor: pointer;
    }

    button:hover, select:hover {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(14,165,164,0.2);
    }

    button:focus, select:focus {
      border-color: var(--focus);
      box-shadow: 0 0 0 2px var(--focus);
    }

    .btn-primary {
      background: linear-gradient(180deg, var(--accent), #0ca89f);
      color: #042022;
      border: none;
    }

    .btn-primary:hover {
      background: linear-gradient(180deg, #0bb8b3, #0ca89f);
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid rgba(255,255,255,.10);
    }

    .btn-ghost:hover {
      background: rgba(255,255,255,0.05);
    }

    /* === Ações Inline === */
    .actions-inline {
      display: none;
      justify-content: center;
      align-items: center;
      gap: 1.5rem;
      background: rgba(255,255,255,0.03);
      border-radius: 0.5rem;
      padding: 0.625rem 1.125rem;
      margin-bottom: 0.75rem;
      flex-wrap: wrap;
    }

    .actions-inline.simulado-active {
      display: flex;
    }

    .timer-box {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: rgba(255,255,255,0.03);
      border-radius: 0.5rem;
      padding: 0.375rem 1.125rem;
      min-width: 130px;
      justify-content: center;
    }

    .timer {
      font-size: 1.09rem;
      font-weight: 800;
      color: var(--accent);
    }

    /* === Estatísticas Inline === */
    .stats-inline {
      display: flex;
      gap: 1.5rem;
      justify-content: center;
      align-items: center;
      margin: 0.625rem 0 1.25rem 0;
      font-size: 1rem;
      background: rgba(255,255,255,0.03);
      border-radius: 0.5rem;
      padding: 0.625rem 1.125rem;
    }

    .stats-inline span {
      color: var(--muted);
    }

    .stats-inline strong {
      color: var(--text-primary);
      font-weight: 600;
      margin-right: 0.125rem;
    }

    /* === Cartão de Pergunta === */
    main {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.875rem;
    }

    .card {
      background: rgba(255,255,255,0.04);
      padding: 1rem;
      border-radius: 0.875rem;
      box-shadow: var(--shadow);
      transition: var(--transition);
    }

    .card:hover {
      box-shadow: 0 8px 24px rgba(0,0,0,.5);
    }

    .card:focus {
      outline: none; /* Removido destaque visual no foco do cartão */
    }

    .question-num {
      font-size: 0.9rem;
      color: var(--muted);
    }

    .question-text {
      font-size: 1.08rem;
      margin: 0.5rem 0;
    }

    .question-image {
      max-width: 100%;
      border-radius: 0.5rem;
      margin-top: 0.5rem;
    }

    .options {
      display: grid;
      gap: 0.625rem;
      margin-top: 0.5rem;
    }

    .opt {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.8125rem 0.625rem;
      border-radius: 0.625rem;
      border: 2px solid rgba(255,255,255,.04);
      background: none;
      cursor: pointer;
      transition: var(--transition);
      font-size: 1rem;
      font-family: inherit;
      outline: none;
      user-select: none;
      text-align: left;
    }

    .opt:hover {
      border-color: var(--accent);
      background: rgba(14,165,164,0.1);
    }

    .opt:focus {
      border-color: var(--focus);
      box-shadow: 0 0 0 2px rgba(251,191,36,0.3); /* Foco suave para navegação por teclado */
    }

    .opt[aria-pressed="true"] {
      border: 2px solid var(--focus);
      background: rgba(251,191,36,0.1); /* Destaque claro para seleção */
    }

    .opt.opt-disabled {
      opacity: 0.65;
      cursor: not-allowed;
    }

    .opt .letter {
      min-width: 34px;
      height: 34px;
      border-radius: 0.5rem;
      display: grid;
      place-items: center;
      background: rgba(255,255,255,0.04);
      font-weight: 700;
      font-size: 1.1em;
    }

    .opt.correct {
      border-color: rgba(22,163,74,.7);
      background: linear-gradient(90deg, rgba(16,185,129,0.09), rgba(16,185,129,0.05));
    }

    .opt.wrong {
      border-color: rgba(239,68,68,.35);
      background: linear-gradient(90deg, rgba(239,68,68,0.07), rgba(239,68,68,0.01));
    }

    .opt img {
      max-height: 80px;
      border-radius: 0.375rem;
    }

    .explanation {
      margin-top: 0.75rem;
      padding: 0.75rem;
      border-radius: 0.5rem;
      background: rgba(255,255,255,0.06);
      color: var(--muted);
      font-size: 0.99rem;
      animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* === Rodapé e Dicas === */
    .small {
      font-size: 0.89rem;
      color: var(--muted);
    }

    footer {
      margin-top: 1rem;
      color: var(--muted);
      font-size: 0.9rem;
      text-align: center;
    }

    .hint {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .visually-hidden {
      position: absolute !important;
      width: 1px;
      height: 1px;
      padding: 0;
      overflow: hidden;
      border: 0;
      clip: rect(0,0,0,0);
      white-space: nowrap;
    }

    /* === Modal de Pontuação Final === */
    .final-score-modal {
      background: var(--card);
      color: var(--text-primary);
      border-radius: 1rem;
      box-shadow: 0 10px 40px rgba(0,0,0,0.6);
      padding: 2rem 1.375rem;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      z-index: 999;
      display: none;
      text-align: center;
      box-sizing: border-box;
      transition: var(--transition);
    }

    .final-score-modal.visible {
      display: block;
      animation: modalFadeIn 0.3s ease-in-out;
    }

    @keyframes modalFadeIn {
      from { opacity: 0; transform: translate(-50%, -55%); }
      to { opacity: 1; transform: translate(-50%, -50%); }
    }

    .final-score-modal h2 {
      margin-top: 0;
    }

    .final-score-modal ul {
      text-align: left;
      margin: 0 auto 1.125rem auto;
      display: inline-block;
    }

    .final-score-modal button {
      margin-top: 1.125rem;
    }

    .final-score-modal .aprovado {
      color: var(--success);
      font-weight: bold;
    }

    .final-score-modal .reprovado {
      color: var(--danger);
      font-weight: bold;
    }

    .question-review {
      margin: 1rem 0;
      padding: 0.75rem;
      background: rgba(255,255,255,0.06);
      border-radius: 0.5rem;
    }

    .question-review p {
      margin: 0.5rem 0;
      word-wrap: break-word;
    }

    /* === Media Queries para Responsividade === */
    @media (max-width: 700px) {
      body {
        padding: 0.5rem;
      }

      .stats-inline, .actions-inline {
        font-size: 0.98rem;
        gap: 0.625rem;
        padding: 0.5rem 0.25rem;
        flex-wrap: wrap;
      }

      .controls {
        flex-wrap: nowrap;
        gap: 0.25rem;
        overflow-x: auto;
        padding-bottom: 0.375rem;
        -webkit-overflow-scrolling: touch;
        justify-content: flex-start;
      }

      .mode-header {
        text-align: center;
        margin-bottom: 0.375rem;
      }

      .mode-indicator {
        font-size: 0.85rem;
        padding: 0.25rem 0.5rem;
      }

      #btnQuiz, #btnSimulado, #categorySelect {
        font-size: 0.85rem;
        min-width: 70px;
        padding: 0.5rem 0.625rem;
      }

      #categorySelect {
        width: 100px;
        min-width: 70px;
      }

      .final-score-modal {
        width: 95vw;
        max-width: 580px;
        min-width: 300px;
        padding: 1.75rem 1.25rem;
        box-sizing: border-box;
      }

      .question-review img {
        max-width: 100%;
        max-height: 150px;
        object-fit: contain;
      }
    }

    /* === Keyframes para Confetti === */
    @keyframes confetti-fall {
      to { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="mode-header">
        <span class="mode-indicator" id="modeIndicator">Modo: <strong>Quiz</strong></span>
      </div>
      <div class="controls" role="group" aria-label="Controles do Quiz">
        <button id="btnQuiz" class="btn-primary" aria-pressed="true" tabindex="0">Quiz</button>
        <button id="btnSimulado" class="btn-ghost" aria-pressed="false" tabindex="0">Simulado</button>
        <label for="categorySelect" class="small">Categorias:</label>
        <select id="categorySelect">
          <option value="all">Todas</option>
        </select>
      </div>
    </header>

    <div class="actions-inline" id="actionsInline">
      <button id="restartBtn" class="btn-ghost" aria-label="Reiniciar quiz">Reiniciar</button>
      <button id="shuffleBtn" class="btn-ghost" aria-label="Embaralhar perguntas">Embaralhar</button>
      <div class="timer-box">
        <span class="small">Tempo:</span>
        <span class="timer" id="timerDisplay" aria-live="polite">--:--:--</span>
      </div>
    </div>

    <div class="stats-inline" id="statsInline" role="region" aria-label="Estatísticas do quiz">
      <span><strong>Perguntas:</strong> <span id="totalAsked">0</span></span>
      <span><strong>Acertos:</strong> <span id="totalCorrect">0</span></span>
      <span><strong>Erros:</strong> <span id="totalWrong">0</span></span>
      <span><strong>Progresso:</strong> <span id="progress">0%</span></span>
    </div>

    <main>
      <section>
        <div class="card" id="questionCard" tabindex="0">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div class="question-num" id="qMeta" aria-live="polite">Carregando perguntas...</div>
              <div class="question-text" id="questionText">—</div>
              <img id="questionImage" class="question-image" src="" alt="Imagem da pergunta" style="display: none;">
            </div>
          </div>
          <div class="options" id="options" role="group" aria-label="Alternativas"></div>
          <div id="explanation" class="explanation" style="display: none;"></div>
          <div style="display: flex; justify-content: space-between; margin-top: 0.875rem; gap: 0.5rem;">
            <div class="hint">Selecione as alternativas corretas. A validação é automática.</div>
            <button id="nextBtn" class="btn-primary" aria-label="Próxima pergunta" tabindex="0">Próxima</button>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <div>
        Observação: Configure as variáveis <code>SHEET_API_URL</code> ou <code>SHEET_CSV_URL</code> para carregar perguntas.<br>
        <span class="visually-hidden" id="accessibilityStatus" aria-live="assertive"></span>
      </div>
    </footer>

    <div class="final-score-modal" id="finalScoreModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" tabindex="-1">
      <!-- Conteúdo gerado dinamicamente -->
    </div>
  </div>

  <script>
    // === Configurações ===
    const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbwVSF5dSd3VFV6jAQBTuhiM9WD8SOqYWttUVzSbNAbcCKqP_6XD00EspkTXHtBb1CnqAQ/exec";
    const SHEET_CSV_URL = "";
    const CATEGORIES = [
      "Network Fundamentals",
      "Network Access",
      "IP connectivity",
      "IP services",
      "Security Fundamentals",
      "Programmability"
    ];
    const SIM_CONFIG = {
      "Network Fundamentals": 20,
      "Network Access": 20,
      "IP connectivity": 25,
      "IP services": 10,
      "Security Fundamentals": 15,
      "Programmability": 10
    };
    const SIM_TOTAL = Object.values(SIM_CONFIG).reduce((a, b) => a + b, 0);

    // === Variáveis de Estado ===
    let allQuestions = [];
    let current = null;
    let answeredQuestions = new Set();
    let asked = 0, correctCount = 0, wrongCount = 0;
    let mode = 'quiz';
    let simQuestions = [];
    let simAnswers = [];
    let simIndex = 0;
    let timer = null;
    let timeLeft = 0;
    let simCategoryScores = {};

    // === Funções Auxiliares ===
    function escapeHTML(str = '') {
      return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function shuffleArray(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function formatTime(s) {
      if (s < 0) s = 0;
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const sec = s % 60;
      return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
    }

    function arraysEqual(a, b) {
      return a.length === b.length && a.every((val, index) => val === b[index]);
    }

    function focusFirstOption() {
      const first = document.querySelector('.opt:not(.opt-disabled)');
      if (first) first.focus();
    }

    function parseCSV(csv) {
      const lines = csv.split(/\r?\n/).filter(l => l.trim() !== "");
      const headers = lines.shift().split(/,|;|\t/).map(h => h.trim());
      return lines.map(line => {
        const values = [];
        let cur = '', inQ = false;
        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          if (ch === '"') inQ = !inQ;
          else if (ch === ',' && !inQ) { values.push(cur); cur = ''; }
          else cur += ch;
        }
        values.push(cur);
        const obj = {};
        headers.forEach((header, i) => {
          obj[header] = (values[i] || '').trim().replace(/^"|"$/g, '');
        });
        return obj;
      });
    }

    // === Carregamento de Dados ===
    async function loadSheet() {
      try {
        let data = null;
        if (SHEET_API_URL) {
          const res = await fetch(SHEET_API_URL);
          if (!res.ok) throw new Error(`Falha na API: ${res.status}`);
          data = await res.json();
        } else if (SHEET_CSV_URL && SHEET_CSV_URL.length > 10 && !SHEET_CSV_URL.includes('PASTE_YOUR')) {
          const res = await fetch(SHEET_CSV_URL);
          if (!res.ok) throw new Error(`Falha ao buscar CSV: ${res.status}`);
          const txt = await res.text();
          data = parseCSV(txt);
        } else {
          document.getElementById('qMeta').textContent = 'Configure SHEET_API_URL ou SHEET_CSV_URL.';
          return;
        }

        allQuestions = (data || []).map((r, idx) => ({
          id: r.id || idx + 1,
          question: (r.question || r.pergunta || '').toString(),
          questionImage: (r.questionImage || r.questionimage || r.image || '').toString(),
          options: {
            A: (r.optionA || r.A || '').toString(),
            B: (r.optionB || r.B || '').toString(),
            C: (r.optionC || r.C || '').toString(),
            D: (r.optionD || r.D || '').toString()
          },
          optionImages: {
            A: (r.optionAImage || r.optionaimage || '').toString(),
            B: (r.optionBImage || r.optionbimage || '').toString(),
            C: (r.optionCImage || r.optioncimage || '').toString(),
            D: (r.optionDImage || r.optiondimage || '').toString()
          },
          correct: (r.correct || r.answer || '').toString().replace(/\s+/g,'').replace(/,/g,';').split(';').filter(Boolean).map(s => s.toUpperCase()),
          category: (r.category || '').toString().trim(),
          explanation: (r.explanation || '').toString()
        })).filter(q => q.question && Object.values(q.options).some(opt => opt));

        const sel = document.getElementById('categorySelect');
        sel.querySelectorAll('option:not([value="all"])').forEach(o => o.remove());
        const presentCats = new Set(allQuestions.map(q => q.category));
        CATEGORIES.filter(cat => presentCats.has(cat)).forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat;
          opt.textContent = cat;
          sel.appendChild(opt);
        });

        if (allQuestions.length === 0) {
          document.getElementById('qMeta').textContent = 'Sem perguntas válidas na planilha.';
          return;
        }

        updateStats();
        nextQuestion();
      } catch (err) {
        console.error(err);
        document.getElementById('qMeta').textContent = `Erro ao carregar: ${err.message}`;
      }
    }

    // === Renderização de Pergunta ===
    function renderQuestion(q) {
      const qMeta = document.getElementById('qMeta');
      const qText = document.getElementById('questionText');
      const qImg = document.getElementById('questionImage');
      const opts = document.getElementById('options');
      const expl = document.getElementById('explanation');

      if (!q) {
        qMeta.textContent = 'Nenhuma pergunta disponível';
        qText.textContent = '—';
        opts.innerHTML = '';
        expl.style.display = 'none';
        qImg.style.display = 'none';
        return;
      }

      current = q;
      qMeta.textContent = mode === 'simulado' 
        ? `Pergunta ${simIndex + 1} de ${SIM_TOTAL} — Categoria: ${escapeHTML(q.category || '—')}`
        : `ID ${escapeHTML(q.id.toString())} — Categoria: ${escapeHTML(q.category || '—')}`;

      qText.textContent = q.question;

      if (q.questionImage) {
        qImg.src = q.questionImage;
        qImg.style.display = 'block';
      } else {
        qImg.style.display = 'none';
        qImg.src = '';
      }

      opts.innerHTML = '';
      expl.style.display = 'none';
      expl.innerHTML = '';

      ['A', 'B', 'C', 'D'].forEach(letter => {
        const txt = q.options[letter];
        if (!txt) return;

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'opt';
        btn.dataset.letter = letter;
        btn.setAttribute('aria-pressed', 'false'); // Garantir que nenhuma alternativa comece selecionada
        btn.setAttribute('aria-label', `Alternativa ${letter}: ${txt}`);
        btn.tabIndex = 0;

        let imgHtml = '';
        if (q.optionImages?.[letter]) {
          imgHtml = `<img src="${escapeHTML(q.optionImages[letter])}" alt="Imagem da alternativa ${letter}">`;
        }

        btn.innerHTML = `<span class="letter">${letter}</span><span class="text">${escapeHTML(txt)}</span>${imgHtml}`;
        btn.addEventListener('click', onSelectOption);
        btn.addEventListener('keydown', e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            btn.click();
          }
        });
        opts.appendChild(btn);
      });

      // Removido o foco automático para evitar destaque inicial
      document.getElementById('questionCard').animate([{ opacity: 0 }, { opacity: 1 }], { duration: 300 });
    }

    // === Exibição de Explicação ===
    function showExplanation(isCorrect) {
      const expl = document.getElementById('explanation');
      expl.style.display = 'block';
      expl.innerHTML = `<strong>${isCorrect ? 'Acertou ✔' : 'Errou ✖'}</strong><div style="margin-top:0.5rem">${escapeHTML(current.explanation || 'Sem explicação disponível.')}</div>`;

      if (!isCorrect) {
        window.scrollTo({
          top: document.body.scrollHeight,
          behavior: 'smooth'
        });
        document.getElementById('questionCard').animate([
          { transform: 'translateX(0)' },
          { transform: 'translateX(-6px)' },
          { transform: 'translateX(6px)' },
          { transform: 'translateX(0)' }
        ], { duration: 360 });
      } else {
        createConfetti();
      }

      const acc = document.getElementById('accessibilityStatus');
      acc.textContent = isCorrect ? 'Resposta correta' : 'Resposta errada';
    }

    // === Função Criativa: Confetti para Acertos ===
    function createConfetti() {
      const colors = ['#16a34a', '#fbbf24', '#0ea5a4'];
      for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.style.position = 'fixed';
        confetti.style.width = `${Math.random() * 10 + 5}px`;
        confetti.style.height = `${Math.random() * 10 + 5}px`;
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.top = `${Math.random() * 100}vh`;
        confetti.style.left = `${Math.random() * 100}vw`;
        confetti.style.opacity = Math.random();
        confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
        confetti.style.animation = `confetti-fall ${Math.random() * 2 + 1}s linear forwards`;
        document.body.appendChild(confetti);
        setTimeout(() => confetti.remove(), 3000);
      }
    }

    // === Seleção e Validação de Opções ===
    function onSelectOption(e) {
      if (!current) return;
      const btn = e.currentTarget;
      if (btn.classList.contains('opt-disabled')) return;
      btn.setAttribute('aria-pressed', btn.getAttribute('aria-pressed') === 'true' ? 'false' : 'true');
      btn.classList.toggle('selected');
      const selected = Array.from(document.querySelectorAll('.opt.selected')).map(x => x.dataset.letter);
      const needed = current.correct.length || 1;
      if (current.correct.length <= 1 || selected.length >= needed) {
        validateAnswer(selected);
      }
    }

    function validateAnswer(selected) {
      document.querySelectorAll('.opt').forEach(o => {
        o.classList.add('opt-disabled');
        o.removeEventListener('click', onSelectOption);
      });

      const correct = current.correct.slice().sort();
      const selSorted = selected.slice().sort();
      const isCorrect = arraysEqual(correct, selSorted);
      asked++;
      if (isCorrect) correctCount++; else wrongCount++;
      updateStats();

      if (mode === 'simulado') {
        simAnswers.push({ question: current, selected, isCorrect });
      }

      if (mode === 'quiz') {
        document.querySelectorAll('.opt').forEach(o => {
          const l = o.dataset.letter;
          if (correct.includes(l)) o.classList.add('correct');
          if (selected.includes(l) && !correct.includes(l)) o.classList.add('wrong');
        });
        showExplanation(isCorrect);
        if (isCorrect) {
          setTimeout(nextQuestion, 1000);
        }
      } else {
        answeredQuestions.add(current.id);
        const cat = current.category;
        if (isCorrect) simCategoryScores[cat] = (simCategoryScores[cat] || 0) + 1;
        simIndex++;
        if (simIndex < simQuestions.length) {
          setTimeout(() => loadSimQuestion(simIndex), 900);
        } else {
          setTimeout(showSimulatedScore, 700);
        }
      }
    }

    // === Atualização de Estatísticas ===
    function updateStats() {
      document.getElementById('totalAsked').textContent = asked;
      document.getElementById('totalCorrect').textContent = correctCount;
      document.getElementById('totalWrong').textContent = wrongCount;
      const pct = Math.round((correctCount / Math.max(1, asked)) * 100);
      document.getElementById('progress').textContent = `${pct}%`;
    }

    function updateStatsInlineVisibility() {
      document.getElementById('statsInline').style.display = mode === 'quiz' ? 'flex' : 'none';
    }

    function updateActionsInlineVisibility() {
      const actions = document.getElementById('actionsInline');
      actions.classList.toggle('simulado-active', mode === 'simulado');
    }

    // === Navegação entre Perguntas ===
    function nextQuestion() {
      const cat = document.getElementById('categorySelect').value;
      let candidates = cat === 'all' ? allQuestions : allQuestions.filter(q => q.category === cat);
      if (candidates.length === 0) {
        document.getElementById('qMeta').textContent = 'Nenhuma pergunta disponível para esta categoria.';
        return;
      }

      const pool = mode === 'quiz' ? candidates : candidates.filter(q => !answeredQuestions.has(q.id)) || candidates;
      if (pool.length === 0) {
        document.getElementById('qMeta').textContent = 'Todas as perguntas respondidas. Reiniciando...';
        setTimeout(() => {
          answeredQuestions.clear();
          nextQuestion();
        }, 1000);
        return;
      }

      const q = pool[Math.floor(Math.random() * pool.length)];
      renderQuestion(q);
    }

    // === Preparação do Modo Simulado ===
    function prepareSimulated() {
      simQuestions = [];
      simAnswers = [];
      simCategoryScores = {};
      for (const cat in SIM_CONFIG) {
        const questionsCat = shuffleArray(allQuestions.filter(q => q.category === cat));
        simQuestions.push(...questionsCat.slice(0, SIM_CONFIG[cat]));
        simCategoryScores[cat] = 0;
      }
      simQuestions = shuffleArray(simQuestions);
      simIndex = 0;
      answeredQuestions.clear();
      asked = correctCount = wrongCount = 0;
      updateStats();
    }

    function loadSimQuestion(i) {
      if (!simQuestions[i]) return renderQuestion(null);
      renderQuestion(simQuestions[i]);
    }

    // === Gerenciamento do Timer ===
    function startTimer(seconds) {
      stopTimer();
      timeLeft = seconds;
      document.getElementById('timerDisplay').textContent = formatTime(timeLeft);
      timer = setInterval(() => {
        timeLeft--;
        document.getElementById('timerDisplay').textContent = formatTime(timeLeft);
        if (timeLeft <= 0) {
          stopTimer();
          showSimulatedScore(true);
        }
      }, 1000);
    }

    function stopTimer() {
      if (timer) clearInterval(timer);
      timer = null;
    }

    // === Exibição de Pontuação Final no Simulado ===
    function showSimulatedScore(timeout = false) {
      stopTimer();
      const modal = document.getElementById('finalScoreModal');
      let html = `<h2 id="modalTitle">${timeout ? 'Tempo Esgotado!' : 'Simulado Finalizado!'}</h2>`;
      html += `<p>Acertos: <strong>${correctCount}</strong> de ${SIM_TOTAL} (${Math.round((correctCount / SIM_TOTAL) * 100)}%)</p>`;
      html += '<ul>';
      for (const cat in SIM_CONFIG) {
        html += `<li>${cat}: <strong>${simCategoryScores[cat] || 0}</strong> de ${SIM_CONFIG[cat]}</li>`;
      }
      html += '</ul>';
      const aprovado = correctCount >= 82;
      html += `<p class="${aprovado ? 'aprovado' : 'reprovado'}" style="font-size:1.2em">Resultado: ${aprovado ? 'APROVADO 🎉' : 'REPROVADO ❌'}</p>`;
      html += '<h3>Revisão das Respostas</h3>';
      simAnswers.forEach((ans, idx) => {
        const q = ans.question;
        const selected = ans.selected;
        const correct = q.correct;
        const isCorrect = ans.isCorrect;
        html += '<div class="question-review">';
        html += `<p><strong>Pergunta ${idx + 1}:</strong> ${escapeHTML(q.question)}</p>`;
        if (q.questionImage) {
          html += `<img src="${escapeHTML(q.questionImage)}" alt="Imagem da pergunta ${idx + 1}" style="max-width:100%; border-radius:0.5rem; margin:0.5rem 0;">`;
        }
        html += `<p><strong>Sua resposta:</strong> ${selected.length ? selected.map(l => `${l}: ${escapeHTML(q.options[l] || '—')}`).join(', ') : 'Nenhuma selecionada'}</p>`;
        html += `<p><strong>Resposta correta:</strong> ${correct.map(l => `${l}: ${escapeHTML(q.options[l] || '—')}`).join(', ')}</p>`;
        html += `<p><strong>Explicação:</strong> ${escapeHTML(q.explanation || 'Sem explicação.')}</p>`;
        html += `<p><strong>Resultado:</strong> <span class="${isCorrect ? 'aprovado' : 'reprovado'}">${isCorrect ? 'Correta ✔' : 'Errada ✖'}</span></p>`;
        html += '</div>';
      });
      html += '<button class="btn-primary" id="closeScoreBtn" tabindex="0">Fechar</button>';
      modal.innerHTML = html;
      modal.classList.add('visible');
      modal.focus();

      // Trap foco no modal para acessibilidade
      const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
      const first = focusableElements[0];
      const last = focusableElements[focusableElements.length - 1];

      modal.addEventListener('keydown', e => {
        if (e.key === 'Tab') {
          if (e.shiftKey && document.activeElement === first) {
            e.preventDefault();
            last.focus();
          } else if (!e.shiftKey && document.activeElement === last) {
            e.preventDefault();
            first.focus();
          }
        }
      });

      document.getElementById('closeScoreBtn').onclick = () => {
        modal.classList.remove('visible');
        mode = 'quiz';
        document.getElementById('modeIndicator').innerHTML = 'Modo: <strong>Quiz</strong>';
        asked = correctCount = wrongCount = 0;
        updateStats();
        updateStatsInlineVisibility();
        updateActionsInlineVisibility();
        nextQuestion();
      };
    }

    // === Eventos ===
    document.getElementById('btnQuiz').addEventListener('click', () => {
      mode = 'quiz';
      document.getElementById('modeIndicator').innerHTML = 'Modo: <strong>Quiz</strong>';
      stopTimer();
      document.getElementById('timerDisplay').textContent = '--:--:--';
      asked = correctCount = wrongCount = 0;
      updateStats();
      document.getElementById('btnQuiz').setAttribute('aria-pressed', 'true');
      document.getElementById('btnSimulado').setAttribute('aria-pressed', 'false');
      updateStatsInlineVisibility();
      updateActionsInlineVisibility();
      nextQuestion();
    });

    document.getElementById('btnSimulado').addEventListener('click', () => {
      mode = 'simulado';
      document.getElementById('modeIndicator').innerHTML = 'Modo: <strong>Simulado</strong>';
      document.getElementById('btnQuiz').setAttribute('aria-pressed', 'false');
      document.getElementById('btnSimulado').setAttribute('aria-pressed', 'true');
      updateStatsInlineVisibility();
      updateActionsInlineVisibility();
      prepareSimulated();
      startTimer(120 * 60);
      loadSimQuestion(0);
    });

    document.getElementById('nextBtn').addEventListener('click', () => {
      if (mode === 'quiz') {
        nextQuestion();
      } else if (simIndex < simQuestions.length) {
        loadSimQuestion(simIndex);
      }
    });

    document.getElementById('restartBtn').addEventListener('click', () => {
      answeredQuestions.clear();
      asked = correctCount = wrongCount = 0;
      updateStats();
      if (mode === 'simulado') {
        prepareSimulated();
        startTimer(120 * 60);
        loadSimQuestion(0);
      } else {
        nextQuestion();
      }
    });

    document.getElementById('shuffleBtn').addEventListener('click', () => {
      allQuestions = shuffleArray(allQuestions);
      alert('Banco de perguntas embaralhado.');
      if (mode === 'quiz') {
        nextQuestion();
      } else if (mode === 'simulado') {
        prepareSimulated();
        loadSimQuestion(0);
      }
    });

    document.getElementById('categorySelect').addEventListener('change', () => {
      if (mode === 'quiz') nextQuestion();
    });

    // === Inicialização ===
    loadSheet();
    updateStatsInlineVisibility();
    updateActionsInlineVisibility();
  </script>
</body>
</html>
