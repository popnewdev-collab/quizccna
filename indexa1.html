<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CCNA PREP QUIZ</title>
  <meta name="description" content="CCNA PREP QUIZ - teste seus conhecimentos para a certifica√ß√£o CCNA" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap">
  <style>
    :root {
      --bg: #0f172a;
      --card: #0b1220;
      --accent: #0ea5a4;
      --muted: #94a3b8;
      --success: #16a34a;
      --danger: #ef4444;
      --focus: #fbbf24;
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, sans-serif;
      color: #e6eef6;
      background: linear-gradient(180deg,#071028 0%, #08122a 100%);
      padding: 16px;
      min-height: 100vh;
    }
    .app { max-width: 980px; margin: 0 auto; }
    header { margin-bottom: 12px }
    .controls { 
      display: flex; 
      gap: 8px; 
      flex-wrap: wrap; 
      align-items: center;
      justify-content: flex-end;
    }
    .actions-inline {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 24px;
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      padding: 10px 18px;
      margin-bottom: 12px;
      flex-wrap: wrap;
      display: none;
    }
    .actions-inline.simulado-active {
      display: flex;
    }
    .timer-box {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      padding: 6px 18px;
      min-width: 130px;
      justify-content: center;
    }
    .quiz-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    h1 { font-size: 1.2rem; margin: 0 }
    .sub { color: var(--muted); font-size: .9rem }
    button, select {
      background: linear-gradient(180deg,#0b1b2a,#06101a);
      border: 1px solid rgba(255,255,255,.08);
      color: #e6eef6;
      padding: 10px 12px;
      border-radius: 10px;
      font-weight: 600;
      font-family: inherit;
      transition: border-color .18s, box-shadow .18s;
      outline: none;
      cursor: pointer;
    }
    button:focus, .opt:focus, select:focus { border-color: var(--focus); box-shadow: 0 0 0 2px var(--focus); }
    .btn-primary {
      background: linear-gradient(180deg,var(--accent),#0ca89f);
      color: #042022;
      border: none;
    }
    .btn-ghost { background: transparent; border: 1px solid rgba(255,255,255,.10);}
    .stats-inline {
      display: flex;
      gap: 24px;
      justify-content: center;
      align-items: center;
      margin: 10px 0 20px 0;
      font-size: 1rem;
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      padding: 10px 18px;
    }
    .stats-inline span {
      color: var(--muted);
    }
    .stats-inline strong {
      color: #e6eef6;
      font-weight: 600;
      margin-right: 2px;
    }
    .mode-header {
      margin-bottom: 8px;
      text-align: left;
      padding: 0 4px;
    }
    .mode-indicator {
      padding: 6px 10px;
      border-radius: 8px;
      background: rgba(255,255,255,0.03);
      font-weight: 700;
      display: inline-block;
    }
    @media (max-width: 700px) {
      .stats-inline, .actions-inline { font-size: .98rem; gap: 10px; padding: 8px 4px; flex-wrap: wrap;}
      .controls {
        flex-wrap: nowrap;
        gap: 4px;
        overflow-x: auto;
        padding-bottom: 6px;
        -webkit-overflow-scrolling: touch;
        justify-content: flex-start;
      }
      .mode-header {
        text-align: center;
        margin-bottom: 6px;
      }
      .mode-indicator {
        font-size: .85rem;
        padding: 4px 8px;
      }
      #btnQuiz, #btnSimulado, #categorySelect {
        font-size: .85rem;
        min-width: 70px;
        padding: 8px 10px;
      }
      #categorySelect {
        width: 100px;
        min-width: 70px;
      }
      .controls label[for="categorySelect"] {
        margin-left: 2px;
        margin-right: 2px;
      }
    }
    main { display: grid; grid-template-columns: 1fr; gap: 14px }
    .card {
      background: rgba(255,255,255,0.04);
      padding: 16px;
      border-radius: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,.4);
    }
    .question-num { font-size: .9rem; color: var(--muted) }
    .question-text { font-size: 1.08rem; margin: 8px 0 8px }
    .question-image { max-width:100%;border-radius:8px;margin-top:8px }
    .options { display: grid; gap: 10px; margin-top: 8px }
    .opt {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 13px 10px;
      border-radius: 10px;
      border: 2px solid rgba(255,255,255,.04);
      background: none;
      cursor: pointer;
      transition: background 0.16s, border-color 0.16s;
      font-size: 1rem;
      font-family: inherit;
      outline: none;
      user-select: none;
      text-align: left;
    }
    .opt[aria-pressed="true"] { outline: 2px solid var(--focus); }
    .opt.opt-disabled { opacity: .65; cursor: not-allowed; }
    .opt .letter {
      min-width: 34px; height: 34px;
      border-radius: 8px;
      display: grid; place-items: center;
      background: rgba(255,255,255,0.04);
      font-weight: 700;
      font-size: 1.1em;
    }
    .opt.correct {
      border-color: rgba(22,163,74,.7);
      background: linear-gradient(90deg, rgba(16,185,129,0.09), rgba(16,185,129,0.05));
    }
    .opt.wrong {
      border-color: rgba(239,68,68,.35);
      background: linear-gradient(90deg, rgba(239,68,68,0.07), rgba(239,68,68,0.01));
    }
    .opt img { max-height: 80px; border-radius: 6px }
    .explanation {
      margin-top: 12px;
      padding: 12px;
      border-radius: 8px;
      background: rgba(255,255,255,0.06);
      color: var(--muted);
      font-size: .99rem;
      animation: fadeIn .3s;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to   { opacity: 1; }
    }
    .small { font-size: .89rem; color: var(--muted) }
    footer { margin-top: 16px; color: var(--muted); font-size: .9rem }
    .hint { font-size: .85rem; color: var(--muted) }
    .visually-hidden { position: absolute !important; width: 1px; height: 1px; padding: 0; overflow: hidden; border: 0; clip: rect(0,0,0,0); white-space: nowrap }
    .timer { font-size: 1.09rem; font-weight: 800; color: var(--accent) }
    .final-score-modal {
      background: var(--card);
      color: #e6eef6;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.6);
      padding: 32px 22px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      position: fixed;
      left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      z-index: 999;
      display: none;
      text-align: center;
    }
    .final-score-modal.visible { display: block; }
    .final-score-modal h2 { margin-top: 0; }
    .final-score-modal ul { text-align: left; margin: 0 auto 18px auto; display:inline-block;}
    .final-score-modal button { margin-top: 18px; }
    .final-score-modal .aprovado { color: var(--success); font-weight: bold;}
    .final-score-modal .reprovado { color: var(--danger); font-weight: bold;}
    .question-review { margin: 16px 0; padding: 12px; background: rgba(255,255,255,0.06); border-radius: 8px; }
    .question-review p { margin: 8px 0; }
  </style>
</head>
<body>
  <div class="app" role="main">
    <header>
      <div class="mode-header">
        <span class="mode-indicator" id="modeIndicator">Modo: <strong>Quiz</strong></span>
      </div>
      <div class="controls" role="group" aria-label="Modos">
        <button id="btnQuiz" class="btn-primary" aria-pressed="true" tabindex="0">Quiz</button>
        <button id="btnSimulado" class="btn-ghost" aria-pressed="false" tabindex="0">Simulado</button>
        <select id="categorySelect" style="width:140px;">
          <option value="all">"Filtro Aleat√≥rio"</option>
        </select>
      </div>
    </header>

    <div class="actions-inline" id="actionsInline">
      <button id="restartBtn" aria-label="Reiniciar quiz">Reiniciar</button>
      <button id="shuffleBtn" class="btn-ghost" aria-label="Embaralhar perguntas">Embaralhar</button>
      <div class="timer-box">
        <span class="small">Tempo simulado</span>
        <span class="timer" id="timerDisplay" aria-live="polite">--:--:--</span>
      </div>
    </div>

    <div class="stats-inline" id="statsInline" role="region" aria-label="Estat√≠sticas do quiz">
      <span><strong>Perguntas:</strong> <span id="totalAsked">0</span></span>
      <span><strong>Acertos:</strong> <span id="totalCorrect">0</span></span>
      <span><strong>Erros:</strong> <span id="totalWrong">0</span></span>
      <span><strong>Progresso:</strong> <span id="progress">0%</span></span>
    </div>

    <main>
      <section>
        <div class="card" id="questionCard">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="question-num" id="qMeta" aria-live="polite">Carregando perguntas...</div>
              <div class="question-text" id="questionText">‚Äî</div>
              <img id="questionImage" class="question-image" src="" alt="" style="display:none">
            </div>
          </div>
          <div class="options" id="options" role="group" aria-label="Alternativas"></div>
          <div id="explanation" class="explanation" style="display:none"></div>
          <div style="display:flex;justify-content:space-between;margin-top:14px;gap:8px">
            <div class="hint">Selecione as alternativas corretas. A valida√ß√£o √© autom√°tica.</div>
            <div>
              <button id="nextBtn" aria-label="Pr√≥xima pergunta" tabindex="0">Pr√≥xima</button>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <div>
        Observa√ß√£o: para carregar perguntas, configure as vari√°veis <code>SHEET_API_URL</code> (Apps Script) ou <code>SHEET_CSV_URL</code> (CSV) no topo do arquivo.<br>
        <span class="visually-hidden" id="accessibilityStatus"></span>
      </div>
    </footer>
    <div class="final-score-modal" id="finalScoreModal" role="dialog" aria-modal="true" tabindex="-1">
      <!-- Conte√∫do gerado dinamicamente -->
    </div>
  </div>
  <script>
    // ====== CONFIGURA√á√ïES ======
    const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbwVSF5dSd3VFV6jAQBTuhiM9WD8SOqYWttUVzSbNAbcCKqP_6XD00EspkTXHtBb1CnqAQ/exec";
    const SHEET_CSV_URL = "";
    const CATEGORIES = [
      "Network Fundamentals",
      "Network Access",
      "IP connectivity",
      "IP services",
      "Security Fundamentals",
      "Programmability"
    ];
    const SIM_CONFIG = {
      "Network Fundamentals": 20,
      "Network Access": 20,
      "IP connectivity": 25,
      "IP services": 10,
      "Security Fundamentals": 15,
      "Programmability": 10
    };
    const SIM_TOTAL = Object.values(SIM_CONFIG).reduce((a, b) => a + b, 0);

    // ====== VARI√ÅVEIS DE ESTADO ======
    let allQuestions = [];
    let current = null;
    let answeredQuestions = new Set();
    let asked = 0, correctCount = 0, wrongCount = 0;
    let mode = 'quiz';
    let simQuestions = [];
    let simAnswers = [];
    let simIndex = 0;
    let timer = null;
    let timeLeft = 0;
    let simCategoryScores = {};

    // ====== HELPERS ======
    function escapeHTML(str = '') {
      return str.replace(/[&<>"']/g, m =>
        ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
      );
    }
    function shuffleArray(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }
    function formatTime(s) {
      if (s < 0) s = 0;
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const sec = s % 60;
      return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
    }
    function arraysEqual(a, b) {
      if (a.length !== b.length) return false;
      for (let i = 0; i < a.length; i++) if (a[i] !== b[i]) return false;
      return true;
    }
    function focusFirstOption() {
      const first = document.querySelector('.opt:not(.opt-disabled)');
      if (first) first.focus();
    }
    function parseCSV(csv) {
      const lines = csv.split(/\r?\n/).filter(l => l.trim() !== "");
      const headers = lines.shift().split(/,|;|\t/).map(h => h.trim());
      return lines.map(line => {
        const values = [];
        let cur = '', inQ = false;
        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          if (ch === '"') inQ = !inQ;
          else if (ch === ',' && !inQ) { values.push(cur); cur = ''; }
          else cur += ch;
        }
        values.push(cur);
        const obj = {};
        for (let i = 0; i < headers.length; i++)
          obj[headers[i]] = (values[i] || '').trim().replace(/^"|"$/g, '');
        return obj;
      });
    }

    // ====== LOADING E PREPARA√á√ÉO ======
    async function loadSheet() {
      try {
        let data = null;
        if (SHEET_API_URL) {
          const res = await fetch(SHEET_API_URL);
          if (!res.ok) throw new Error('Falha na API: ' + res.status);
          data = await res.json();
        } else if (SHEET_CSV_URL && !SHEET_CSV_URL.includes('PASTE_YOUR') && SHEET_CSV_URL.length > 10) {
          const res = await fetch(SHEET_CSV_URL);
          if (!res.ok) throw new Error('Falha ao buscar CSV: ' + res.status);
          const txt = await res.text();
          data = parseCSV(txt);
        } else {
          document.getElementById('qMeta').innerText = 'Configure SHEET_API_URL ou SHEET_CSV_URL nas configs.';
          return;
        }
        allQuestions = (data || []).map((r, idx) => ({
          id: r.id || idx + 1,
          question: (r.question || r.pergunta || '').toString(),
          questionImage: (r.questionImage || r.questionimage || r.image || '').toString(),
          options: {
            A: (r.optionA || r.A || '').toString(),
            B: (r.optionB || r.B || '').toString(),
            C: (r.optionC || r.C || '').toString(),
            D: (r.optionD || r.D || '').toString()
          },
          optionImages: {
            A: (r.optionAImage||r.optionaimage||'').toString(),
            B: (r.optionBImage||r.optionbimage||'').toString(),
            C: (r.optionCImage||r.optioncimage||'').toString(),
            D: (r.optionDImage||r.optiondimage||'').toString()
          },
          correct: (r.correct||r.answer||'').toString().replace(/\s+/g,'').replace(/,/g,';').split(';').filter(Boolean).map(s=>s.toUpperCase()),
          category: (r.category||'').toString().trim(),
          explanation: (r.explanation || '').toString()
        })).filter(q => q.question && (q.options.A || q.options.B || q.options.C || q.options.D));
        const sel = document.getElementById('categorySelect');
        Array.from(sel.querySelectorAll('option:not([value="all"])')).forEach(o => o.remove());
        const present = new Set(allQuestions.map(q => q.category));
        const catsToShow = CATEGORIES.filter(c => present.has(c));
        for (const cat of catsToShow) {
          const opt = document.createElement('option');
          opt.value = cat; opt.innerText = cat; sel.appendChild(opt);
        }
        if (allQuestions.length === 0) {
          document.getElementById('qMeta').innerText = 'Planilha carregada mas sem perguntas v√°lidas.';
          return;
        }
        updateStats();
        nextQuestion();
      } catch (err) {
        console.error(err);
        document.getElementById('qMeta').innerText = 'Erro ao carregar planilha: ' + err.message;
      }
    }

    // ====== RENDERIZA√á√ÉO ======
    function renderQuestion(q) {
      const qMeta = document.getElementById('qMeta');
      const qText = document.getElementById('questionText');
      const qImg = document.getElementById('questionImage');
      const opts = document.getElementById('options');
      const expl = document.getElementById('explanation');
      if (!q) {
        qMeta.innerText = 'Nenhuma pergunta dispon√≠vel';
        qText.innerText = '‚Äî';
        opts.innerHTML = '';
        expl.style.display = 'none';
        qImg.style.display = 'none';
        return;
      }
      current = q;
      if (mode === 'simulado') {
        qMeta.innerText = `Pergunta ${simIndex + 1} de ${SIM_TOTAL} ‚Äî Categoria: ${escapeHTML(q.category||'‚Äî')}`;
      } else {
        qMeta.innerText = `ID ${escapeHTML(q.id.toString())} ‚Äî Categoria: ${escapeHTML(q.category||'‚Äî')}`;
      }
      qText.innerText = q.question;
      if (q.questionImage) {
        qImg.src = q.questionImage;
        qImg.style.display = 'block';
        qImg.alt = "Imagem da pergunta";
      } else {
        qImg.style.display = 'none';
        qImg.src = '';
      }
      opts.innerHTML = '';
      expl.style.display = 'none';
      expl.innerHTML = '';
      ['A','B','C','D'].forEach(letter => {
        const txt = q.options[letter];
        if (!txt) return;
        const btn = document.createElement('button');
        btn.type = "button";
        btn.className = 'opt';
        btn.dataset.letter = letter;
        btn.setAttribute('aria-label', `Alternativa ${letter}: ${txt}`);
        btn.tabIndex = 0;
        let imgHtml = '';
        if (q.optionImages && q.optionImages[letter]) {
          imgHtml = `<img src="${escapeHTML(q.optionImages[letter])}" alt="Imagem alternativa ${letter}">`;
        }
        btn.innerHTML = `<span class="letter">${letter}</span><span class="text">${escapeHTML(txt)}</span>${imgHtml}`;
        btn.addEventListener('click', onSelectOption);
        btn.addEventListener('keydown', e => {
          if (e.key === "Enter" || e.key === " ") { e.preventDefault(); btn.click(); }
        });
        opts.appendChild(btn);
      });
      setTimeout(focusFirstOption, 120);
    }

    function showExplanation(isCorrect) {
      const expl = document.getElementById('explanation');
      expl.style.display = 'block';
      expl.innerHTML = `<strong>${isCorrect ? 'Acertou ‚úî' : 'Errou ‚úñ'}</strong><div style="margin-top:8px">${escapeHTML(current.explanation || 'Sem explica√ß√£o.')}</div>`;
      if (!isCorrect) {
        document.getElementById('questionCard').animate([{transform:'translateX(0)'},{transform:'translateX(-6px)'},{transform:'translateX(6px)'},{transform:'translateX(0)'}],{duration:360});
      }
      const acc = document.getElementById('accessibilityStatus');
      acc.innerText = isCorrect ? "Resposta correta" : "Resposta errada";
      acc.setAttribute('aria-live', 'assertive');
    }

    // ====== L√ìGICA DE SELE√á√ÉO E VALIDA√á√ÉO ======
    function onSelectOption(e) {
      if (!current) return;
      const btn = e.currentTarget;
      if (btn.classList.contains('opt-disabled')) return;
      btn.setAttribute('aria-pressed', btn.getAttribute('aria-pressed') === "true" ? "false" : "true");
      btn.classList.toggle('selected');
      const selected = Array.from(document.querySelectorAll('.opt.selected')).map(x => x.dataset.letter);
      const needed = current.correct.length || 1;
      if (current.correct.length <= 1 || selected.length >= needed) {
        validateAnswer(selected);
      }
    }

    function validateAnswer(selected) {
      document.querySelectorAll('.opt').forEach(o => {
        o.classList.add('opt-disabled');
        o.removeEventListener('click', onSelectOption);
      });
      const correct = current.correct.slice().sort();
      const selSorted = selected.slice().sort();
      const isCorrect = arraysEqual(correct, selSorted);
      asked++;
      if (isCorrect) correctCount++; else wrongCount++;
      updateStats();

      if (mode === 'simulado') {
        simAnswers.push({
          question: current,
          selected: selected,
          isCorrect: isCorrect
        });
      }

      if (mode === 'quiz') {
        document.querySelectorAll('.opt').forEach(o => {
          const l = o.dataset.letter;
          if (correct.includes(l)) o.classList.add('correct');
          if (selected.includes(l) && !correct.includes(l)) o.classList.add('wrong');
        });
        showExplanation(isCorrect);
        if (isCorrect) {
          setTimeout(() => nextQuestion(), 2000);
        }
      } else {
        answeredQuestions.add(current.id);
        const cat = current.category;
        if (isCorrect) {
          if (!simCategoryScores[cat]) simCategoryScores[cat] = 0;
          simCategoryScores[cat]++;
        }
        simIndex++;
        if (simIndex < simQuestions.length) {
          setTimeout(() => loadSimQuestion(simIndex), 900);
        } else {
          setTimeout(() => showSimulatedScore(), 700);
        }
      }
    }

    // ====== NAVEGA√á√ÉO E ESTAT√çSTICAS ======
    function updateStats() {
      document.getElementById('totalAsked').innerText = asked;
      document.getElementById('totalCorrect').innerText = correctCount;
      document.getElementById('totalWrong').innerText = wrongCount;
      const pct = Math.round((correctCount / Math.max(1, asked)) * 100);
      document.getElementById('progress').innerText = pct + '%';
    }

    function updateStatsInlineVisibility() {
      const stats = document.getElementById('statsInline');
      stats.style.display = mode === 'quiz' ? '' : 'none';
    }

    function updateActionsInlineVisibility() {
      const actions = document.getElementById('actionsInline');
      if (mode === 'simulado') {
        actions.classList.add('simulado-active');
      } else {
        actions.classList.remove('simulado-active');
      }
      /* Corre√ß√£o: Zerar contadores e ocultar cron√¥metro */
      console.log('updateActionsInlineVisibility chamado. Modo:', mode, 'Classe simulado-active:', actions.classList.contains('simulado-active'));
    }

    function nextQuestion() {
      const cat = document.getElementById('categorySelect').value;
      let candidates = cat === 'all' ? allQuestions.slice() : allQuestions.filter(q => q.category === cat);
      if (!candidates || candidates.length === 0) {
        console.error('Nenhuma pergunta dispon√≠vel. allQuestions:', allQuestions, 'category:', cat);
        document.getElementById('qMeta').innerText = 'Nenhuma pergunta dispon√≠vel para esta categoria. Tente outra.';
        return;
      }
      const poolCand = mode === 'quiz' ? candidates : candidates.filter(q => !answeredQuestions.has(q.id)) || candidates;
      if (poolCand.length === 0) {
        console.warn('Todas as perguntas foram respondidas. Reiniciando pool.');
        document.getElementById('qMeta').innerText = 'Todas as perguntas foram respondidas. Reiniciando.';
        setTimeout(() => {
          answeredQuestions.clear();
          nextQuestion();
        }, 1000);
        return;
      }
      const q = poolCand[Math.floor(Math.random() * poolCand.length)];
      renderQuestion(q);
    }

    function prepareSimulated() {
      simQuestions = [];
      simAnswers = [];
      simCategoryScores = {};
      for (const cat in SIM_CONFIG) {
        const questionsCat = shuffleArray(allQuestions.filter(q => q.category === cat));
        simQuestions.push(...questionsCat.slice(0, SIM_CONFIG[cat]));
        simCategoryScores[cat] = 0;
      }
      simQuestions = shuffleArray(simQuestions);
      simIndex = 0;
      answeredQuestions = new Set();
      asked = 0; correctCount = 0; wrongCount = 0;
      updateStats();
    }

    function loadSimQuestion(i) {
      if (!simQuestions[i]) { renderQuestion(null); return; }
      renderQuestion(simQuestions[i]);
    }

    // ====== TIMER SIMULADO ======
    function startTimer(seconds) {
      stopTimer();
      timeLeft = seconds;
      document.getElementById('timerDisplay').innerText = formatTime(timeLeft);
      timer = setInterval(() => {
        timeLeft--;
        document.getElementById('timerDisplay').innerText = formatTime(timeLeft);
        if (timeLeft <= 0) { stopTimer(); showSimulatedScore(true); }
      }, 1000);
    }
    function stopTimer() { if (timer) clearInterval(timer); timer = null; }

    // ====== SCORE FINAL DO SIMULADO ======
    function showSimulatedScore(timeout = false) {
      stopTimer();
      const modal = document.getElementById("finalScoreModal");
      let html = `<h2>${timeout ? "Tempo Esgotado!" : "Simulado Finalizado!"}</h2>`;
      html += `<p>Acertos: <strong>${correctCount}</strong> de ${SIM_TOTAL} (${Math.round((correctCount/SIM_TOTAL)*100)}%)</p>`;
      html += `<ul>`;
      for (const cat in SIM_CONFIG) {
        html += `<li>${cat}: <strong>${simCategoryScores[cat] || 0}</strong> de ${SIM_CONFIG[cat]}</li>`;
      }
      html += `</ul>`;
      const aprovado = correctCount >= 82;
      html += `<p class="${aprovado ? "aprovado" : "reprovado"}" style="font-size:1.2em">
                Resultado: ${aprovado ? 'APROVADO üéâ' : 'REPROVADO ‚ùå'}
              </p>`;
      html += `<h3>Revis√£o das Respostas</h3>`;
      simAnswers.forEach((ans, idx) => {
        const q = ans.question;
        const selected = ans.selected;
        const correct = q.correct;
        const isCorrect = ans.isCorrect;
        html += `<div class="question-review">`;
        html += `<p><strong>Pergunta ${idx + 1}:</strong> ${escapeHTML(q.question)}</p>`;
        if (q.questionImage) {
          html += `<img src="${escapeHTML(q.questionImage)}" alt="Imagem da pergunta ${idx + 1}" style="max-width:100%;border-radius:8px;margin:8px 0">`;
        }
        html += `<p><strong>Sua resposta:</strong> ${selected.length ? selected.map(l => `${l}: ${escapeHTML(q.options[l] || '‚Äî')}`).join(', ') : 'Nenhuma selecionada'}</p>`;
        html += `<p><strong>Resposta correta:</strong> ${correct.map(l => `${l}: ${escapeHTML(q.options[l] || '‚Äî')}`).join(', ')}</p>`;
        html += `<p><strong>Explica√ß√£o:</strong> ${escapeHTML(q.explanation || 'Sem explica√ß√£o.')}</p>`;
        html += `<p><strong>Resultado:</strong> <span class="${isCorrect ? 'aprovado' : 'reprovado'}">${isCorrect ? 'Correta ‚úî' : 'Errada ‚úñ'}</span></p>`;
        html += `</div>`;
      });
      html += `<button class="btn-primary" id="closeScoreBtn" tabindex="0">Fechar</button>`;
      modal.innerHTML = html;
      modal.classList.add("visible");
      modal.focus();
      document.getElementById("closeScoreBtn").onclick = () => {
        modal.classList.remove("visible");
        mode = "quiz";
        document.getElementById('modeIndicator').innerHTML = 'Modo: <strong>Quiz</strong>';
        /* Corre√ß√£o: Zerar contadores e ocultar cron√¥metro */
        asked = 0;
        correctCount = 0;
        wrongCount = 0;
        updateStats();
        updateStatsInlineVisibility();
        updateActionsInlineVisibility();
        nextQuestion();
      };
    }

    // ====== EVENTOS ======
    document.getElementById('btnQuiz').addEventListener('click', () => {
      mode = 'quiz';
      document.getElementById('modeIndicator').innerHTML = 'Modo: <strong>Quiz</strong>';
      stopTimer();
      document.getElementById('timerDisplay').innerText = '--:--:--';
      asked = 0; correctCount = 0; wrongCount = 0;
      updateStats();
      document.getElementById('btnQuiz').setAttribute('aria-pressed','true');
      document.getElementById('btnSimulado').setAttribute('aria-pressed','false');
      updateStatsInlineVisibility();
      updateActionsInlineVisibility();
      nextQuestion();
    });

    document.getElementById('btnSimulado').addEventListener('click', () => {
      mode = 'simulado';
      document.getElementById('modeIndicator').innerHTML = 'Modo: <strong>Simulado</strong>';
      document.getElementById('btnQuiz').setAttribute('aria-pressed','false');
      document.getElementById('btnSimulado').setAttribute('aria-pressed','true');
      updateStatsInlineVisibility();
      updateActionsInlineVisibility();
      prepareSimulated();
      startTimer(120 * 60);
      loadSimQuestion(0);
    });

    document.getElementById('nextBtn').addEventListener('click', () => {
      console.log('Bot√£o Pr√≥xima clicado. Modo:', mode);
      if (mode === 'quiz') {
        nextQuestion();
      } else if (simIndex < simQuestions.length) {
        loadSimQuestion(simIndex);
      }
    });

    document.getElementById('restartBtn').addEventListener('click', () => {
      answeredQuestions = new Set();
      asked = 0; correctCount = 0; wrongCount = 0;
      updateStats();
      if (mode === 'simulado') {
        prepareSimulated();
        startTimer(120 * 60);
        loadSimQuestion(0);
      } else {
        nextQuestion();
      }
    });

    document.getElementById('shuffleBtn').addEventListener('click', () => {
      allQuestions = shuffleArray(allQuestions);
      alert('Banco embaralhado.');
      if (mode === 'quiz') {
        nextQuestion();
      } else if (mode === 'simulado') {
        prepareSimulated();
        loadSimQuestion(0);
      }
    });

    document.getElementById('categorySelect').addEventListener('change', () => {
      if (mode === 'quiz') nextQuestion();
    });

    // ====== INICIALIZA ======
    loadSheet();
    updateStatsInlineVisibility();
    updateActionsInlineVisibility();
  </script>
</body>
</html>
